# Spring 초기 설정

## 1. 프로젝트 생성

- **프로젝트 선택**
    - Project: **Gradle - Groovy**
    - Language: Java
    - Spring Boot: **3.2.5**
- **Project Metadata**
    - Group: com
    - Artifact: ourpos
    - Name: ourpos
    - Package name: **com.ourpos**
    - Packaging: **Jar**
    - Java: **17**
- **Dependencies:**
    - Spring Web
    - Spring Data JPA
    - Spring Data Redis
    - Mariadb driver
    - H2
    - Spring Security
    - Java Mail Sender
    - Validation
    - Lombok
    - **Querydsl**
        - Version: **5.0.0**
    - **Test**
        - JUnit
        - Spring Boot Test
        - Spring Security Test

## 2. build.gradle 설정

```groovy
buildscript {
    ext {
        querydslVersion = '5.0.0'
    }
}

plugins {
    id 'java'
    id 'org.springframework.boot' version '3.2.5'
    id 'io.spring.dependency-management' version '1.1.4'
}

group = 'com'
version = '0.0.1-SNAPSHOT'

java {
    sourceCompatibility = '17'
}

configurations {
    compileOnly {
        extendsFrom annotationProcessor
    }
}

repositories {
    mavenCentral()
}

dependencies {
    // Spring Boot
    implementation 'org.springframework.boot:spring-boot-starter-data-jpa'
    implementation 'org.springframework.boot:spring-boot-starter-data-redis'
    implementation 'org.springframework.boot:spring-boot-starter-mail'
    implementation 'org.springframework.boot:spring-boot-starter-security'
    implementation 'org.springframework.boot:spring-boot-starter-validation'
    implementation 'org.springframework.boot:spring-boot-starter-web'

    // H2, MariaDB
    runtimeOnly 'com.h2database:h2'
    runtimeOnly 'org.mariadb.jdbc:mariadb-java-client'

    // Lombok
    compileOnly 'org.projectlombok:lombok'
    annotationProcessor 'org.projectlombok:lombok'
    testCompileOnly 'org.projectlombok:lombok'
    testAnnotationProcessor 'org.projectlombok:lombok'

    // QueryDSL
    implementation 'com.querydsl:querydsl-jpa:5.0.0:jakarta'
    annotationProcessor "com.querydsl:querydsl-apt:${dependencyManagement.importedProperties['querydsl.version']}:jakarta"
    annotationProcessor "jakarta.annotation:jakarta.annotation-api"
    annotationProcessor "jakarta.persistence:jakarta.persistence-api"

    // Test
    testImplementation 'org.springframework.boot:spring-boot-starter-test'
    testImplementation 'org.springframework.security:spring-security-test'
    testRuntimeOnly 'org.junit.platform:junit-platform-launcher'
}

def generated = 'src/main/generated'

tasks.withType(JavaCompile).configureEach {
    options.getGeneratedSourceOutputDirectory().set(file(generated))
}

sourceSets {
    main.java.srcDirs += [generated]
}

clean {
    delete file(generated)
}

tasks.named('test') {
    useJUnitPlatform()
}
```

## 3. application.yml 설정

크게 local, dev, prod 환경으로 나누어 설정한다.

`application-local.yml`

```yaml
spring:
  config:
    activate:
      on-profile: local

  datasource:
    url: jdbc:h2:tcp://localhost/~/ourpos
    username: sa
    password:
    driver-class-name: org.h2.Driver

  jpa:
    hibernate:
      ddl-auto: create
    properties:
      hibernate:
        format_sql: true
        default_batch_fetch_size: 100
    defer-datasource-initialization: true

  sql:
    init:
      platform: h2
      data-locations: classpath:/db/data.sql
      mode: always

  h2:
    console:
      enabled: true

logging.level:
  org.hibernate.SQL: debug
#  org.hibernate.orm.jdbc.bind: trace
```

로컬에서 DB는 가벼운 H2를 사용하고, 개발, 운영 환경에서는 MariaDB를 사용한다.  
ddl-auto는 create로 설정하여 테이블을 생성한다.

main/resources 디렉토리에 `db/data.sql` 파일을 생성하여 초기 데이터를 설정한다.

#### default_batch_fetch_size

`default_batch_fetch_size`는 한 번에 가져올 데이터의 양을 설정한다. 기본값은 1이다.
100으로 설정하면 100개의 데이터를 한 번에 가져온다. (일대다 관계 에서 N+1 문제 해결)

